@page "/"
@using StellarForge.Web.Models
@using StellarForge.Web.Services
@inject StellarForgeApiService ApiService

<PageTitle>StellarForge - Star System Generator</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">
        <span class="text-primary">⭐</span> StellarForge
        <small class="text-muted">Star System Generator</small>
    </h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }

    @if (!backendAvailable)
    {
        <div class="alert alert-warning" role="alert">
            <strong>Backend Offline:</strong> Could not connect to API at http://localhost:8080/api
            <br/>Please start the Rust backend: <code>cd backend && cargo run</code>
        </div>
    }

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Generate Stars</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@request" OnValidSubmit="@HandleGenerate">
                        <div class="mb-3">
                            <label class="form-label">Project Name</label>
                            <InputText class="form-control" @bind-Value="request.Name" placeholder="My Galaxy" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Number of Stars</label>
                            <InputNumber class="form-control" @bind-Value="request.NumStars" min="1" max="10000" />
                            <small class="text-muted">1 to 10,000 star systems</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Distribution Type</label>
                            <select class="form-select" @bind="request.DistributionType">
                                <option value="sphere">Sphere</option>
                                <option value="cube">Cube</option>
                            </select>
                        </div>

                        @if (request.DistributionType == "sphere")
                        {
                            <div class="mb-3">
                                <label class="form-label">Radius (Light Years)</label>
                                <InputNumber class="form-control" @bind-Value="request.RadiusLy" min="1" max="10000" />
                            </div>
                        }
                        else if (request.DistributionType == "cube")
                        {
                            <div class="mb-3">
                                <label class="form-label">Size X (Light Years)</label>
                                <InputNumber class="form-control" @bind-Value="request.SizeXLy" min="1" max="10000" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Size Y (Light Years)</label>
                                <InputNumber class="form-control" @bind-Value="request.SizeYLy" min="1" max="10000" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Size Z (Light Years)</label>
                                <InputNumber class="form-control" @bind-Value="request.SizeZLy" min="1" max="10000" />
                            </div>
                        }

                        <button type="submit" class="btn btn-primary w-100" disabled="@isGenerating">
                            @if (isGenerating)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <text>Generating...</text>
                            }
                            else
                            {
                                <text>Generate Stars</text>
                            }
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            @if (result != null)
            {
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">✓ Generation Complete</h5>
                    </div>
                    <div class="card-body">
                        <h6>Project: <strong>@result.Name</strong></h6>
                        <hr/>

                        <div class="row">
                            <div class="col-md-6">
                                <h6>Statistics</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Total Systems:</td>
                                        <td><strong>@result.NumStarSystems</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Total Stars:</td>
                                        <td><strong>@result.NumStarsTotal</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Generation Time:</td>
                                        <td><strong>@result.GenerationTimeMs ms</strong></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>System Types</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Solo Systems:</td>
                                        <td><strong>@result.SoloSystems</strong> (@((result.SoloSystems * 100.0 / result.NumStarSystems).ToString("F1"))%)</td>
                                    </tr>
                                    <tr>
                                        <td>Binary Systems:</td>
                                        <td><strong>@result.BinarySystems</strong> (@((result.BinarySystems * 100.0 / result.NumStarSystems).ToString("F1"))%)</td>
                                    </tr>
                                    <tr>
                                        <td>Trinary Systems:</td>
                                        <td><strong>@result.TrinarySystems</strong> (@((result.TrinarySystems * 100.0 / result.NumStarSystems).ToString("F1"))%)</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <strong>Project ID:</strong> <code>@result.ProjectId</code>
                        </div>
                    </div>
                </div>
            }

            @if (projects != null && projects.Any())
            {
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Recent Projects</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Systems</th>
                                    <th>Stars</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var project in projects.Take(5))
                                {
                                    <tr>
                                        <td><strong>@project.Name</strong></td>
                                        <td>@project.NumStarSystems</td>
                                        <td>@project.NumStarsTotal</td>
                                        <td><span class="badge bg-info">@project.DistributionType</span></td>
                                        <td><small>@project.CreatedAt</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private GenerateRequest request = new()
    {
        Name = "MyGalaxy",
        NumStars = 100,
        DistributionType = "sphere",
        RadiusLy = 100.0
    };

    private GenerateResponse? result;
    private List<ProjectSummary> projects = new();
    private bool isGenerating = false;
    private string? errorMessage;
    private bool backendAvailable = false;

    protected override async Task OnInitializedAsync()
    {
        // Check backend availability
        backendAvailable = await ApiService.CheckHealthAsync();

        // Load recent projects
        if (backendAvailable)
        {
            var response = await ApiService.GetProjectsAsync();
            if (response != null)
            {
                projects = response.Projects;
            }
        }
    }

    private async Task HandleGenerate()
    {
        errorMessage = null;
        isGenerating = true;
        result = null;

        try
        {
            // Validate request
            if (string.IsNullOrWhiteSpace(request.Name))
            {
                errorMessage = "Project name cannot be empty";
                return;
            }

            if (request.NumStars < 1 || request.NumStars > 10000)
            {
                errorMessage = "Number of stars must be between 1 and 10,000";
                return;
            }

            if (request.DistributionType == "cube")
            {
                if (!request.SizeXLy.HasValue || !request.SizeYLy.HasValue || !request.SizeZLy.HasValue)
                {
                    errorMessage = "Cube distribution requires all three dimensions";
                    return;
                }
                // Clear sphere parameter
                request.RadiusLy = null;
            }
            else
            {
                if (!request.RadiusLy.HasValue)
                {
                    errorMessage = "Sphere distribution requires radius";
                    return;
                }
                // Clear cube parameters
                request.SizeXLy = null;
                request.SizeYLy = null;
                request.SizeZLy = null;
            }

            // Call API
            result = await ApiService.GenerateProjectAsync(request);

            if (result == null)
            {
                errorMessage = "Failed to generate project. Check backend logs.";
            }
            else
            {
                // Refresh projects list
                var response = await ApiService.GetProjectsAsync();
                if (response != null)
                {
                    projects = response.Projects;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
        }
    }
}
